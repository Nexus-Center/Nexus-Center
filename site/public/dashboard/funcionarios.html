<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Center | Funcionários</title>
    <link rel="stylesheet" href="../css/reset.css">
    <link rel="stylesheet" href="../css/funcionarios.css">
    <link rel="Logo icon" href="../assets/globo.png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body onload="kpiFuncionariosAtivos(), kpiFuncionariosAusentes(), kpiFuncionariosInativos(), atualizacaoPeriodica()">
    <div class="maedetodos">
        <nav class="nav-lateral">

            <div class=" logo">
                <a href="../index.html"><img src="../assets/logo.png" alt="NexusCenter" width="150vh"></a>
            </div>

            <div class="container-mae">
                <ul class="nav-list">
                    <li class="maq"><a href="funcionarios.html"> <img src="../assets/dash/dash.png" width="20vh">
                            Funcionários </a>
                    </li>
                    <li><a href="maquinas.html"> <img src="../assets/dash/maquina.png" width="15vh"> Máquinas </a>
                    </li>
                    <li><a href="download.html"> <img src="../assets/dash/downlold.png" width="20h" height="20vh">
                            Aplicação </a>
                    </li>
                    <li><a href="cadastroMaquina.html"> <img src="../assets/dash/addMaquina.png" width="15h"> Adicionar
                            Máquina </a>
                    </li>
                    <li><a onclick="limparSessao()"> <img src="../assets/dash/exit.png" width="15vh"> Sair </a>
                    </li>
                </ul>
            </div>
        </nav>
        <div class="magica">
            <div class="container-tabela">
                <h1> Relatório dos Funcionários</h1>
                <div class="tabela">
                    <table>
                        <thead>
                            <tr>
                                <td>Nome</td>
                                <td>Máquina</td>
                                <td>Status</td>
                                <td>USB Conectado</td>
                            </tr>
                        </thead>
                        <tbody id="tabela_funcionarios">
                        </tbody>
                    </table>

                </div>
            </div>

            <!-- KPI de atividade dos funcionários atual -->
            <div class="container-status">

                <div class="status">
                    <h1> Atividade dos Funcionários Atual</h1>
                    
                    <div class="cardDesempenho">
                        <div class="verde">
                            <h1 class="funcionariosAtivos" id="funcionariosAtivos"> 0 </h1>
                            <h2> Ativos </h2>
                        </div>

                        <div class="vermelho">
                            <h1 class="funcionariosInativos" id="funcionariosInativos"> 0 </h1>
                            <h2> Inativos </h2>
                        </div>
                        <div class="classBar"></div>
                        <div class="amarelo">
                            <h1 class="funcionariosAusentes" id="funcionariosAusentes"> 0 </h1>
                            <h2> Ausentes </h2>
                        </div>
                    </div>

                    <div>
                        <div class="pings">
                            <div class="circle" id="verd"></div>
                            <h1> Ativos - atividade detectada</h1>
                        </div>
                        
                        <div class="pings">
                            <div class="circle" id="vermP"></div>
                            <h1> Inativos - sem atividade detectada</h1>
                        </div>

                        <div class="pings">
                            <div class="circle" id="amarel"></div>
                            <h1> Ausentes - login não efetuado</h1>
                        </div>
                    </div>

                </div>

                <!-- Gráfico de atividade dos funcionários últimas 6 horas -->
                <div class="corpo-grafico">
                    <h1> Atividade dos funcionários </h1>
                    <h1> últimas 6 horas</h1>

                    <canvas id="myChart"></canvas>
                </div>

            </div>


        </div>

    </div>

</body>

</html>

<script>
    const dados = {
        labels: ["08:00", "09:00", "10:00", "11:00", "12:00", "13:00", "14:00"],
        datasets: [
            {
                label: "Ativos",
                backgroundColor: "rgb(79, 243, 93)",
                borderColor: "rgb(79, 243, 93)",
                borderWidth: 1,
                data: [23, 20, 24, 23, 22, 24]
            },
            {
                label: "Ausentes",
                backgroundColor: "rgb(233, 191, 25)",
                borderColor: "rgb(233, 191, 25)",
                borderWidth: 1,
                data: [10, 9, 11, 2, 18, 10]
            },
            {
                label: "Inativos",
                backgroundColor: "rgb(243, 79, 79)",
                borderColor: "rgb(243, 79, 79)",
                borderWidth: 1,
                data: [2, 5, 1, 2, 8, 1]
            },
        ]

    };


    const config = {
        type: 'bar',
        data: dados,
        options: {
            indexAxis: 'y',
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        },
    };


    const myChart = new Chart(
        document.getElementById('myChart'),
        config
    );

    function limparSessao() {
        // aguardar();
        sessionStorage.clear();
        // finalizarAguardar();
        window.location = "../login.html";
    }
</script>

<script>
    var ativo = sessionStorage.getItem('QTD_ATIVO');
    var ausente = sessionStorage.getItem('QTD_AUSENTE');
    var inativo = sessionStorage.getItem('QTD_INATIVO');

    // Função para atualizar as kpis toda vez que reiniciar a página
    function kpiFuncionariosAtivos() {
        fetch(`/usuarios/kpiFuncionariosAtivos`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    console.log("A resposta é :" + resposta[0]);
                    sessionStorage.QTD_ATIVO = resposta[0].qtdAtivos
                    ativo = sessionStorage.getItem('QTD_ATIVO');
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados para KPI: ${error.message}`);
            });

        funcionariosAtivos.innerHTML = ativo
    }

    function kpiFuncionariosAusentes() {
        fetch(`/usuarios/kpiFuncionariosAusentes`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    console.log("A resposta é :" + resposta[0]);
                    sessionStorage.QTD_AUSENTE = resposta[0].qtdAusentes
                    ausente = sessionStorage.getItem('QTD_AUSENTE');
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados para KPI: ${error.message}`);
            });

        funcionariosAusentes.innerHTML = ausente
    }

    function kpiFuncionariosInativos() {
        fetch(`/usuarios/kpiFuncionariosInativos`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    console.log("A resposta é :" + resposta[0]);
                    sessionStorage.QTD_INATIVO = resposta[0].qtdInativos
                    inativo = sessionStorage.getItem('QTD_INATIVO');
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados para KPI: ${error.message}`);
            });

            funcionariosInativos.innerHTML = inativo
    }

</script>

<!-- inserção dos funcionarios -->
<script>

    const idEmpresa = sessionStorage.getItem('FKEMPRESA_USUARIO')
    
    function atualizacaoPeriodica() {
        
        obterDados(idEmpresa);

        // function sendData() {
		// 	var http = new XMLHttpRequest();
		// 	http.open('POST', 'http://localhost:3000/api/sendData', false);
		// 	http.send(null);
		// }

        setInterval(() => {
			// sendData();
		}, 2000);
        setTimeout(atualizacaoPeriodica, 5000);
    }

    function obterDados(idEmpresa) {
        tabela_funcionarios.innerHTML = ``
        fetch(`/usuarios/tempo-real/${idEmpresa}`).then(resposta => {
            if (resposta.ok) {
                resposta.json().then(resposta => {

                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);

                    for(i = 0; i < resposta.length; i++){
                        usuario = resposta[i].nomeUsuario
                        patrimonio = resposta[i].patrimonio
                        tabela_funcionarios.innerHTML += `
                            <tr>
                                <td>${usuario}</td>
                                <td>${patrimonio}</td>
                                <td>
                                    <h2> Ativo </h2>
                                </td>
                                <td>Sim</td>
                            </tr>
                        `
                    }
                });
            } else {

                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
        .catch(function (error) {
            console.error(`Erro na obtenção dos dados da máquina p/ gráfico: ${error.message}`);
        });

    }
</script>