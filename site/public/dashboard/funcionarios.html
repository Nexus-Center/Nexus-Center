<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Center | Funcionários</title>
    <link rel="stylesheet" href="../css/reset.css">
    <link rel="stylesheet" href="../css/funcionarios.css">
    <link rel="Logo icon" href="../assets/globo.png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body onload=" obterLinhas(idEmpresa)">
    <div class="maedetodos">
        <nav class="nav-lateral">

            <div class=" logo">
                <a href="../index.html"><img src="../assets/logo.png" alt="NexusCenter" width="150vh"></a>
            </div>

            <div class="container-mae">
                <ul class="nav-list">
                    <li class="maq"><a href="funcionarios.html"> <img src="../assets/dash/dash.png" width="20vh">
                            Funcionários </a>
                    </li>
                    <li><a href="maquinas.html"> <img src="../assets/dash/maquina.png" width="15vh"> Máquinas </a>
                    </li>
                    <li><a href="download.html"> <img src="../assets/dash/downlold.png" width="20h" height="20vh">
                            Aplicação </a>
                    </li>
                    <li><a href="cadastroMaquina.html"> <img src="../assets/dash/addMaquina.png" width="15h"> Adicionar
                            Máquina </a>
                    </li>
                    <li><a onclick="limparSessao()"> <img src="../assets/dash/exit.png" width="15vh"> Sair </a>
                    </li>
                </ul>
            </div>
        </nav>
        <div class="magica">
            <div class="container-tabela">
                <h1> Relatório dos Funcionários</h1>
                <div class="tabela">
                    <table>
                        <thead>
                            <tr>
                                <td>Nome</td>
                                <td>Patrimônio</td>
                                <td>Status</td>
                                <td>USB Conectado</td>
                            </tr>
                        </thead>
                        <tbody id="tabela_funcionarios">
                        </tbody>
                    </table>

                </div>
            </div>

            <!-- KPI de atividade dos funcionários atual -->
            <div class="container-status">

                <div class="status">
                    <h1> Atividade dos Funcionários Atual</h1>
                    <div class="cardDesempenho">
                        <div class="verde">
                            <h1 class="funcionariosAtivos" id="funcionariosAtivos"> 0 </h1>
                            <h2> Ativos </h2>
                        </div>

                        <div class="amarelo">
                            <h1 class="funcionariosAusentes" id="funcionariosAusentes"> 0 </h1>
                            <h2> Ausentes </h2>
                        </div>

                        <div class="vermelho">
                            <h1 class="funcionariosInativos" id="funcionariosInativos"> 0 </h1>
                            <h2> Inativos </h2>
                        </div>
                    </div>
                </div>

                <!-- Gráfico de atividade dos funcionários últimas 6 horas -->
                <div class="corpo-grafico">
                    <h1> Atividade dos funcionários </h1>
                    <h1> na última hora</h1>

                    <canvas id="myChart"></canvas>
                </div>

            </div>


        </div>

    </div>

</body>

</html>

<!-- inserção dos funcionarios -->
<script>
    
    const idEmpresa = sessionStorage.getItem('FKEMPRESA_USUARIO')
    var limite_linhas = 0

    function obterLinhas(idEmpresa) {
        fetch(`/usuarios/obter_linhas/${idEmpresa}`).then(resposta => {
            if (resposta.ok) {
                resposta.json().then(resposta => {

                    // console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    
                    limite_linhas = resposta[0].numeroMaquinas;
                    // console.log(resposta)
                    atualizacaoPeriodica()
                    // obterDadosGrafico(idEmpresa, limite_linhas);
                });
            } else {
                
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
        .catch(function (error) {
            console.error(`Erro na obtenção dos dados da máquina p/ gráfico: ${error.message}`);
        });
        
    }
    
    
    function atualizacaoPeriodica() {
        
        obterDados(limite_linhas);
        obterDadosGrafico(idEmpresa, limite_linhas);

        // function sendData() {
		// 	var http = new XMLHttpRequest();
		// 	http.open('POST', 'http://localhost:3000/api/sendData', false);
		// 	http.send(null);
		// }

        setInterval(() => {
			// sendData();
		}, 2000);
        setTimeout(atualizacaoPeriodica, 5000);
    }
    
    var erros = 0;
    
    function obterDados(limite_linhas) {
        tabela_funcionarios.innerHTML = ``
        fetch(`/usuarios/tempo-real/${limite_linhas}`).then(resposta => {
            if (resposta.ok) {
                resposta.json().then(resposta => {

                    // console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    
                    var ativos = 0;
                    var ausentes = 0;
                    var inativos = 0;

                    for(i = 0; i < resposta.length; i++){
                        usuario = resposta[i].nomeUsuario;
                        patrimonio = resposta[i].patrimonio;
                        status = resposta[i].statusMouse;
                        var cor = '';

                        if(status.toLowerCase() == "ativo"){
                            ativos++;
                            cor = '#34D411';
                        } else if(status.toLowerCase() == "ausente"){
                            ausentes++;
                            cor = '#e9bf19';
                        } else if(status.toLowerCase() == "inativo"){
                            inativos++;
                            cor = '#aa1313';
                        } else {
                            erros++;
                        }

                        tabela_funcionarios.innerHTML += `
                            <tr>
                                <td>${usuario}</td>
                                <td>${patrimonio}</td>
                                <td>
                                    <h2  style="color: ${cor}">${status}</h2>
                                </td>
                                <td>Sim</td>
                            </tr>
                        `
                    }

                    funcionariosAtivos.innerHTML = ativos;
                    funcionariosAusentes.innerHTML = ausentes;
                    funcionariosInativos.innerHTML = inativos;

                });
            } else {

                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
        .catch(function (error) {
            console.error(`Erro na obtenção dos dados da máquina: ${error.message}`);
        });

    }

    function obterDadosGrafico(idEmpresa, limite_linhas) {

        var usuarios = [];
        var ativos = [];
        var ausentes = [];
        var inativos = [];

        for(idMaquina = 1; idMaquina <= limite_linhas; idMaquina++){
            fetch(`/usuarios/obterDadosGrafico/${idMaquina}`).then(resposta => {
                if (resposta.ok) {
                    resposta.json().then(resposta => {
                        
                        // console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);

                        resposta.reverse();
                        var maquinaUsuario = '';
                        var maquinaAtivo = 0;
                        var maquinaAusente = 0;
                        var maquinaInativo = 0;

                        for(i = 0; i < resposta.length; i++){
                            maquinaUsuario = resposta[i].nomeUsuario
                            var status = resposta[i].statusMouse;
                            if(status.toLowerCase() == 'ativo'){
                                maquinaAtivo++;
                            } else if(status.toLowerCase() == 'ausente'){
                                maquinaAusente++;
                            } else if(status.toLowerCase() == 'inativo'){
                                maquinaInativo++;
                            } else {
                                erros++;
                            }
                        }
                        
                        usuarios.push(maquinaUsuario);
                        // console.log(usuarios.length);
                        ativos.push(maquinaAtivo);
                        ausentes.push(maquinaAusente);
                        inativos.push(maquinaInativo);

                        // console.log(`Usuario: ${usuarios}; Ativos: ${ativos}; Ausentes: ${ausentes}; Inativos: ${inativos}`)
                        plotarGrafico(limite_linhas, usuarios, ativos, ausentes, inativos)

                    });
                } else {

                    console.error('Nenhum dado encontrado ou erro na API');
                }
            })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados da máquina p/ gráfico: ${error.message}`);
            });
            
        }
        
    }
    
    function plotarGrafico(limite_linhas, usuarios, ativos, ausentes, inativos){
        
        if(usuarios.length == limite_linhas){

            var dados = {
                // labels: ['Bruno','Thamires','Vinicius','Vitor','Rafael','Vitoria'],
                labels: [],
                datasets: [
                    {
                        label: "Ativos",
                        backgroundColor: "rgb(79, 243, 93)",
                        borderColor: "rgb(79, 243, 93)",
                        borderWidth: 1,
                        data: []
                        // data: [42,42,0,0,0,0]
                    },
                    {
                        label: "Ausentes",
                        backgroundColor: "rgb(233, 191, 25)",
                        borderColor: "rgb(233, 191, 25)",
                        borderWidth: 1,
                        data: []
                    },
                    {
                        label: "Inativos",
                        backgroundColor: "rgb(243, 79, 79)",
                        borderColor: "rgb(243, 79, 79)",
                        borderWidth: 1,
                        data: []
                    },
                ]
        
            };

            // console.log(usuarios.length)
            // console.log(limite_linhas)

            
            for(i = 0; i < usuarios.length; i++){
                dados.labels.push(usuarios[i]);
                dados.datasets[0].data.push(ativos[i]);
                dados.datasets[1].data.push(ausentes[i]);
                dados.datasets[2].data.push(inativos[i]);
            }
            console.log(dados.labels)
            console.log(dados.datasets[0].data)
            console.log(dados.datasets[1].data)
            console.log(dados.datasets[2].data)
            
            const config = {
                type: 'bar',
                data: dados,
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    scales: {
                        x: {
                            stacked: true
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true
                        }
                    }
                },
            };
        
            var myChart = new Chart(
                document.getElementById('myChart'),
                config
            );
            
            myChart.destroy();

            myChart = new Chart(
                document.getElementById('myChart'),
                config
            );
        }

    }

    function limparSessao() {
        // aguardar();
        sessionStorage.clear();
        // finalizarAguardar();
        window.location = "../login.html";
    }
</script>