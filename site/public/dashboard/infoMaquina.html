<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/reset.css">
    <link rel="stylesheet" href="../css/infoMaquina.css">
    <link rel="Logo icon" href="../assets/globo.png">
    <script src="../js/infoMaquina.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>Máquina</title>
</head>

<body>
    <div class="maedetodos">
        <nav class="nav-lateral">

            <div class=" logo">
                <a href="../index.html"><img src="../assets/logo.png" alt="NexusCenter" width="150vh"></a>

                <div class="container-mae">
                    <ul class="nav-list">
                        <li class="maq"><a href="maquinas.html">
                            <img src="../assets/dash/maquina.png" width="15vh">
                             <h1 id="nomeDaMaquina"> </h1></a></li>
                    </ul>
                </div>
            </div>

            <div class="infoHardware" id="infoHardware">
                <h3> Inf. Hardware:</h3>
                <h1>Sistema Operacional: </h1>
                <h1> Processador: </h1>
                <h1> Memória Ram:  </h1>
                <h1>Capacidade Disco: </h1>
            </div>

            <div class="logouts">
                <ul>
                    <li><a href="#" onclick="deleteMaquina()"> <img src="../assets/dash/lixeira.png" width="15vh"> Deletar Máquina</a></li>
                    <li><a href="maquinas.html"> <img src="../assets/dash/exit.png" width="15vh"> Voltar</a></li>
                </ul>
            </div>
        </nav>

        <div class="container-graficos">
            <div class="superior">

                <div class="container-cpu">
                    <div class="corpo-grafico">
                        <div class="titulo-grafico">
                            <h1> Indicadores de uso da CPU </h1>
                            <div class="circle" id="statusCircle"></div>
                        </div>
                        <div class="kpi">
                            <div class="caixa verd">
                                <h1> 70% </h1>
                                <h2> Ideal </h2>
                            </div>

                            <div class="caixa amarel">
                                <h1> 80% </h1>
                                <h2> Atenção </h2>
                            </div>

                            <div class="caixa verm">
                                <h1> 90% </h1>
                                <h2> Alerta</h2>
                            </div>

                        </div>
                        <div class="grafico">
                            <canvas id="cpu-chart"></canvas>
                        </div>
                    </div>

                    <div class="status">
                        <div class="statusAtual">
                            <h1> Status:<b class="alerta" id="statusTexto"> </b></h1>
                        </div>

                        <div class="utilizacao">
                            <h1> Utilização: </h1>
                            <b id="cpuUtiliza"> </b>
                        </div>

                    </div>
                </div>


                <div class="container-cpu">
                    <div class="corpo-grafico">
                        <div class="titulo-grafico">
                            <h1> Indicadores de uso de Memória</h1>
                            <div class="circle" id="statusCircleM"></div>
                        </div>
                        <div class="kpi">
                            <div class="caixa verd">
                                <h1> 70% </h1>
                                <h2> Ideal </h2>
                            </div>

                            <div class="caixa amarel">
                                <h1> 80% </h1>
                                <h2> Atenção </h2>
                            </div>

                            <div class="caixa verm">
                                <h1> 90% </h1>
                                <h2> Alerta</h2>
                            </div>
                        </div>
                        <div class="grafico">
                            <canvas id="mem-chart"></canvas>
                        </div>
                    </div>

                    <div class="status">
                        <div class="statusAtual">
                            <h1> Status:<b class="ideal" id="statusTexto2"> </b></h1>
                        </div>

                        <div class="utilizacao">
                            <h1> Utilização: </h1>
                            <b id="memUtiliza"> </b>
                        </div>

                    </div>
                </div>
            </div>


            <div class="inferior">

                <div class="container-cpu">
                    <div class="corpo-grafico">
                        <div class="titulo-grafico">
                            <h1> Indicadores de uso do Disco</h1>
                            <div class="circle" id="statusCircleD"></div>
                        </div>
                        <div class="kpi">
                            <div class="caixa verd">
                                <h1> 70% </h1>
                                <h2> Ideal </h2>
                            </div>

                            <div class="caixa amarel">
                                <h1> 80% </h1>
                                <h2> Atenção </h2>
                            </div>

                            <div class="caixa verm">
                                <h1> 90% </h1>
                                <h2> Alerta</h2>
                            </div>

                        </div>
                        <div class="grafico">
                            <canvas id="disco-chart"></canvas>
                        </div>
                    </div>

                    <div class="status">
                        <div class="statusAtual">
                            <h1> Status:<b class="atencao" id="statusTexto3"></b></h1>
                        </div>

                        <div class="utilizacao">
                            <h1> Utilização: </h1>
                            <b id="hdUtiliza"> </b>
                        </div>

                    </div>
                </div>


                <div class="container-usb">
                    <div class="corpo-usb" id="corpoUSB">
                        <h1> USB Conectado:</h1>

                        <div class="dispositivos" id="dispo">
                            <h2> </h2>
                            <div class="line"></div>
                        </div>


                    </div>

                    <div class="aviso">
                        <div class="texto-aviso">
                            <h1>Caso algum componente da máquina esteja no status de <b> Alerta </b> recomenda-se a
                                solicitação do
                                serviço de suporte da empresa, pois isso pode comprometer o desempenho do funcionário.
                            </h1>
                        </div>
                    </div>
                </div>

            </div>
    </body>
</html>

<script>

let maquinaPorcentagem = [];
const fk_maquina = localStorage.getItem("ID_MAQUINA");
let resposta;
let maquinaUso;
let utiliza;
let listaStatus;


async function getPorcentagemUso() {
  resposta = await (fetch(`/usuarios/getPorcentagemUso/${fk_maquina}`));
  maquinaPorcentagem = await resposta.json()
  console.log(maquinaPorcentagem);

  maquinaUso = {
    hdUso: maquinaPorcentagem.slice(-6).map(maquina => maquina.porcentagemHD),
    memUso: maquinaPorcentagem.slice(-6).map(maquina => maquina.porcentagemMem),
    cpuUso: maquinaPorcentagem.slice(-6).map(maquina => maquina.porcentagemProc),
    horario: maquinaPorcentagem.slice(-6).map(maquina => maquina.dataHora)
   }





console.log(maquinaUso)

setUtilizacao()
atualizarStatus()
}

function setUtilizacao(){
    cpuUtiliza.innerHTML = maquinaUso.cpuUso.slice(-1) + "%"
    hdUtiliza.innerHTML = maquinaUso.hdUso.slice(-1) + "%"
    memUtiliza.innerHTML = maquinaUso.memUso.slice(-1) + "%"
}

function atualizarStatus(){
    var circleElement = document.getElementById('statusCircle');
    var circleElement2 = document.getElementById('statusCircleM');
    var circleElement3 = document.getElementById('statusCircleD');
    var style = document.createElement('style');
    style.innerHTML = `
      @keyframes blink {
        0% { opacity: 1; }
        50% { opacity: 0; }
        100% { opacity: 1; }
      }
      .vermP {
        background-color: #d41818;
        animation: blink 1s infinite;
      }
    `;


    if(maquinaUso.cpuUso.slice(-1) < 70){
    circleElement.style.backgroundColor = '#27ff35';
    statusTexto.innerHTML = '<span style="color: #27ff35;"> Ideal</span>';
    circleElement.classList.remove('vermP');
    }else if(maquinaUso.cpuUso.slice(-1) > 70 && maquinaUso.cpuUso.slice(-1) < 90){
    circleElement.style.backgroundColor = '#f2aa00';
    statusTexto.innerHTML = '<span style="color: #f2aa00;"> Atenção </span>';
    circleElement.classList.remove('vermP');
    }else{
    document.head.appendChild(style);
    circleElement.style.backgroundColor = '#d41818';
    circleElement.classList.add('vermP');
    statusTexto.innerHTML = '<span style="color: #d41818;"> Alerta </span>';
    }

    if(maquinaUso.memUso.slice(-1) < 70){
    circleElement2.style.backgroundColor = '#27ff35';
    statusTexto2.innerHTML = '<span style="color: #27ff35;"> Ideal </span>';
    circleElement3.classList.remove('vermP');
    }else if(maquinaUso.memUso.slice(-1) > 70 && maquinaUso.memUso.slice(-1) < 90){
    circleElement2.style.backgroundColor = '#f2aa00';
    statusTexto2.innerHTML = '<span style="color: #f2aa00;"> Atenção </span>';
    circleElement3.classList.remove('vermP');
    }else{
    document.head.appendChild(style);
    circleElement2.classList.add('vermP');
    statusTexto2.innerHTML = '<span style="color: #d41818;"> Alerta </span>';
    }

    if(maquinaUso.hdUso.slice(-1) < 70){
    circleElement3.style.backgroundColor = '#27ff35';
    statusTexto3.innerHTML = '<span style="color: #27ff35;"> Ideal </span>';
    circleElement3.classList.remove('vermP');
    }else if(maquinaUso.hdUso.slice(-1) > 70 && maquinaUso.hdUso.slice(-1) < 90){
    circleElement3.style.backgroundColor = '#f2aa00';
    statusTexto3.innerHTML = '<span style="color: #f2aa00;"> Atenção </span>';
    circleElement3.classList.remove('vermP');
    }else{
    document.head.appendChild(style);
    circleElement.style.backgroundColor = '#d41818';
    circleElement3.classList.add('vermP');
    statusTexto3.innerHTML = '<span style="color: #d41818;"> Alerta </span>';
    }

}


   
function formatarHorario(data) {
  const dataObjeto = new Date(data); // Converte a string em um objeto Date
  const horario = dataObjeto.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
  return horario;
}

getPorcentagemUso();

setTimeout(() => {
atualizarInfoGrafico();
}, 1000) 

setInterval(() => {
    getPorcentagemUso();
    atualizarInfoGrafico(); 
}, 5000)
 


async function atualizarInfoGrafico(){
    if(maquinaUso){
    atualizarGrafico("cpu-chart", "CPU", maquinaUso.cpuUso);
    atualizarGrafico("mem-chart", "Memória RAM", maquinaUso.memUso);
    atualizarGrafico("disco-chart", "Disco", maquinaUso.hdUso);
    }

}


function atualizarGrafico(id, label, data){
let chartInstance = Chart.getChart(id)

if(!chartInstance){
    gerarGrafico(id, label, data);
}else{
    chartInstance.data.datasets[0].data = data;
    chartInstance.update();
}
}


function gerarGrafico(id, label, data){

var ctx = document.getElementById(id).getContext('2d');
var newChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: maquinaUso.horario.map(hora => formatarHorario(hora)),
        datasets: [{
            label: label,
            data: data,
            backgroundColor: 'rgba(62, 62, 167)',
            borderColor: 'rgba(62, 62, 167)',
            borderWidth: 1
        }]
    },
    options: {
        scales: {
            yAxes: [{
                ticks: {
                    beginAtZero: true
                }
            }]
        }
    }
});

}



</script>
